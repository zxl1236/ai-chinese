# 🌐 AI语文助手 - 生产环境部署指南

## 🎯 部署选项

### 方案一：传统VPS/云服务器部署

#### 1. 服务器环境准备
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip nginx git

# CentOS/RHEL
sudo yum install python3 python3-pip nginx git
```

#### 2. 部署后端API
```bash
# 克隆项目
git clone <your-repo-url>
cd AI语文/backend

# 安装依赖
pip3 install -r requirements.txt

# 配置环境变量
export QWEN_API_KEY="your_qwen_api_key"
export DEEPSEEK_API_KEY="your_deepseek_api_key"

# 使用Gunicorn部署
pip3 install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

#### 3. 配置Nginx反向代理
```nginx
# /etc/nginx/sites-available/ai-chinese
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /path/to/AI语文;
        index app.html;
        try_files $uri $uri/ /app.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 4. 启用站点
```bash
sudo ln -s /etc/nginx/sites-available/ai-chinese /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 方案二：Docker容器化部署

#### 1. 创建Dockerfile
```dockerfile
# 后端Dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY backend/requirements.txt .
RUN pip install -r requirements.txt

COPY backend/ .
EXPOSE 5000

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "app:app"]
```

#### 2. 创建docker-compose.yml
```yaml
version: '3.8'
services:
  backend:
    build: .
    ports:
      - "5000:5000"
    environment:
      - QWEN_API_KEY=${QWEN_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
    restart: unless-stopped

  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend
    restart: unless-stopped
```

#### 3. 部署命令
```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 方案三：免费托管平台部署

#### Vercel部署（前端）
```bash
# 安装Vercel CLI
npm i -g vercel

# 部署前端
vercel

# 配置vercel.json
{
  "functions": {
    "api/[...].js": {
      "runtime": "nodejs18.x"
    }
  },
  "rewrites": [
    {
      "source": "/api/(.*)",
      "destination": "https://your-backend-url.com/api/$1"
    }
  ]
}
```

#### Railway部署（后端）
```bash
# 安装Railway CLI
npm install -g @railway/cli

# 登录并部署
railway login
railway init
railway up
```

## 🔧 生产环境优化

### 1. 性能优化
```python
# backend/app.py 添加缓存
from flask_caching import Cache

cache = Cache(app, config={'CACHE_TYPE': 'simple'})

@app.route('/api/chat', methods=['POST'])
@cache.cached(timeout=300, key_prefix='chat')
def chat():
    # ... 原有代码
```

### 2. 安全配置
```python
# 添加CORS配置
from flask_cors import CORS

CORS(app, origins=['https://your-domain.com'])

# 添加API限流
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app,
    key_func=get_remote_address,
    default_limits=["100 per hour"]
)
```

### 3. 监控和日志
```python
# 添加日志配置
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s %(levelname)s %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)
```

## 🔑 API密钥配置

### 环境变量方式（推荐）
```bash
# Linux/Mac
export QWEN_API_KEY="your_key"
export DEEPSEEK_API_KEY="your_key"

# Windows
set QWEN_API_KEY=your_key
set DEEPSEEK_API_KEY=your_key
```

### 配置文件方式
```python
# backend/config.py
import os

class Config:
    QWEN_API_KEY = os.environ.get('QWEN_API_KEY')
    DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY')
```

## ✅ 部署检查清单

- [ ] 后端API服务正常启动
- [ ] 前端页面可以访问
- [ ] AI助手按钮可以点击
- [ ] API密钥配置正确
- [ ] CORS配置允许跨域
- [ ] HTTPS证书配置（生产环境）
- [ ] 域名DNS解析正确
- [ ] 防火墙端口开放
- [ ] 服务进程守护配置
- [ ] 日志监控配置

## 🐛 故障排查

### 前端无法访问后端
1. 检查API URL配置
2. 确认CORS设置
3. 查看网络请求错误

### AI功能不工作
1. 检查API密钥
2. 确认模型可用性
3. 查看后端日志

### 性能问题
1. 启用CDN加速
2. 优化图片资源
3. 启用Gzip压缩
4. 配置缓存策略
